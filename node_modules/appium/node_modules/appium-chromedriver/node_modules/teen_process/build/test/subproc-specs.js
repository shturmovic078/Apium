'use strict';

var _Promise = require('babel-runtime/core-js/promise')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _ = require('../..');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

require('mochawait');

var _helpers = require('./helpers');

require('source-map-support').install();

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

describe('SubProcess', function () {
  it('should throw an error if initialized without a command', function () {
    should['throw'](function () {
      new _.SubProcess();
    });
  });
  it('should throw an error if initialized with a bad command', function () {
    should['throw'](function () {
      new _.SubProcess({ lol: true });
    });
    should['throw'](function () {
      new _.SubProcess(1);
    });
  });
  it('should throw an error if initialized with bad args', function () {
    should['throw'](function () {
      new _.SubProcess('ls', 'foo');
    });
    should['throw'](function () {
      new _.SubProcess('ls', 1);
    });
    should['throw'](function () {
      new _.SubProcess('ls', {});
    });
  });
  it('should default args list to []', function () {
    var x = new _.SubProcess('ls');
    x.args.should.eql([]);
  });

  describe('#start', function () {
    it('should throw an error if command fails on startup', function callee$2$0() {
      var s;
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            s = new _.SubProcess('blargimarg');
            context$3$0.next = 3;
            return s.start().should.eventually.be.rejectedWith(/ENOENT/);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should have a default startDetector of waiting for output', function callee$2$1() {
      var hasData, s;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            hasData = false;
            s = new _.SubProcess('ls');

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 5;
            return s.start();

          case 5:
            hasData.should.be['true'];

          case 6:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should interpret a numeric startDetector as a start timeout', function callee$2$2() {
      var hasData, s;
      return _regeneratorRuntime.async(function callee$2$2$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            hasData = false;
            s = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls']);

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 5;
            return s.start(0);

          case 5:
            hasData.should.be['false'];
            context$3$0.next = 8;
            return _bluebird2['default'].delay(1200);

          case 8:
            hasData.should.be['true'];

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should fail even with a start timeout of 0 when command is bad', function callee$2$3() {
      var s;
      return _regeneratorRuntime.async(function callee$2$3$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            s = new _.SubProcess('blargimarg');
            context$3$0.next = 3;
            return s.start(0).should.eventually.be.rejectedWith(/ENOENT/);

          case 3:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
    it('should be able to provide a custom startDetector function', function callee$2$4() {
      var sd, hasData, s;
      return _regeneratorRuntime.async(function callee$2$4$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            sd = function sd(stdout) {
              return stdout;
            };

            hasData = false;
            s = new _.SubProcess('ls');

            s.on('output', function (stdout) {
              if (stdout) {
                hasData = true;
              }
            });
            context$3$0.next = 6;
            return s.start(sd);

          case 6:
            hasData.should.be['true'];

          case 7:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('listening for data', function () {
    var subproc = undefined;
    it('should get output as params', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this2 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            context$3$0.next = 2;
            return new _Promise(function callee$3$0(resolve) {
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess(_helpers.getFixture('sleepyproc.sh'), ['ls', _path2['default'].resolve(__dirname)]);
                    subproc.on('output', function (stdout) {
                      if (stdout && stdout.indexOf('subproc-specs') !== -1) {
                        resolve();
                      }
                    });
                    context$4$0.next = 4;
                    return subproc.start();

                  case 4:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this2);
            });

          case 2:
            context$3$0.next = 4;
            return subproc.stop();

          case 4:
            context$3$0.next = 6;
            return new _Promise(function callee$3$1(resolve) {
              return _regeneratorRuntime.async(function callee$3$1$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess(_helpers.getFixture('echo.sh'), ['foo', 'bar']);
                    subproc.on('output', function (stdout, stderr) {
                      if (stderr && stderr.indexOf('bar') !== -1) {
                        resolve();
                      }
                    });
                    context$4$0.next = 4;
                    return subproc.start();

                  case 4:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this2);
            });

          case 6:
            context$3$0.next = 8;
            return subproc.stop();

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should get output by lines', function callee$2$1() {
      var lines;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess('ls', [_path2['default'].resolve(__dirname)]);
            lines = [];

            subproc.on('lines-stdout', function (newLines) {
              lines = lines.concat(newLines);
            });
            context$3$0.next = 5;
            return subproc.start(0);

          case 5:
            context$3$0.next = 7;
            return _bluebird2['default'].delay(50);

          case 7:
            lines.should.eql(['exec-specs.js', 'fixtures', 'helpers.js', 'subproc-specs.js']);

          case 8:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });

  describe('#stop', function () {
    it('should send the right signal to stop a proc', function callee$2$0() {
      return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
        var _this3 = this;

        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            return context$3$0.abrupt('return', new _Promise(function callee$3$0(resolve, reject) {
              var subproc;
              return _regeneratorRuntime.async(function callee$3$0$(context$4$0) {
                while (1) switch (context$4$0.prev = context$4$0.next) {
                  case 0:
                    subproc = new _.SubProcess('tail', ['-f', _path2['default'].resolve(__filename)]);
                    context$4$0.next = 3;
                    return subproc.start();

                  case 3:
                    subproc.on('exit', function (code, signal) {
                      try {
                        signal.should.equal('SIGHUP');
                        resolve();
                      } catch (e) {
                        reject(e);
                      }
                    });
                    context$4$0.next = 6;
                    return subproc.stop('SIGHUP');

                  case 6:
                  case 'end':
                    return context$4$0.stop();
                }
              }, null, _this3);
            }));

          case 1:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should time out if stop doesnt complete fast enough', function callee$2$1() {
      var subproc;
      return _regeneratorRuntime.async(function callee$2$1$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess(_helpers.getFixture('traphup.sh'), ['tail', '-f', _path2['default'].resolve(__filename)]);
            context$3$0.next = 3;
            return subproc.start();

          case 3:
            context$3$0.next = 5;
            return subproc.stop('SIGHUP', 10).should.eventually.be.rejectedWith(/Process didn't end/);

          case 5:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });

    it('should error if there is no process to stop', function callee$2$2() {
      var subproc;
      return _regeneratorRuntime.async(function callee$2$2$(context$3$0) {
        while (1) switch (context$3$0.prev = context$3$0.next) {
          case 0:
            subproc = new _.SubProcess('ls');
            context$3$0.next = 3;
            return subproc.stop().should.eventually.be.rejectedWith(/Can't stop/);

          case 3:
            context$3$0.next = 5;
            return subproc.start();

          case 5:
            context$3$0.next = 7;
            return _bluebird2['default'].delay(10);

          case 7:
            context$3$0.next = 9;
            return subproc.stop().should.eventually.be.rejectedWith(/Can't stop/);

          case 9:
          case 'end':
            return context$3$0.stop();
        }
      }, null, _this);
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3Qvc3VicHJvYy1zcGVjcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O3dCQUVjLFVBQVU7Ozs7b0JBQ1AsTUFBTTs7OztnQkFDSSxPQUFPOztvQkFDakIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7UUFDdEMsV0FBVzs7dUJBQ1MsV0FBVzs7QUFSdEMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7O0FBVXhDLElBQU0sTUFBTSxHQUFHLGtCQUFLLE1BQU0sRUFBRSxDQUFDO0FBQzdCLGtCQUFLLEdBQUcsNkJBQWdCLENBQUM7O0FBRXpCLFFBQVEsQ0FBQyxZQUFZLEVBQUUsWUFBTTtBQUMzQixJQUFFLENBQUMsd0RBQXdELEVBQUUsWUFBTTtBQUNqRSxVQUFNLFNBQU0sQ0FBQyxZQUFNO0FBQ2pCLFlBWkcsVUFBVSxFQVlHLENBQUM7S0FDbEIsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0FBQ0gsSUFBRSxDQUFDLHlEQUF5RCxFQUFFLFlBQU07QUFDbEUsVUFBTSxTQUFNLENBQUMsWUFBTTtBQUNqQixZQWpCRyxVQUFVLENBaUJFLEVBQUMsR0FBRyxFQUFFLElBQUksRUFBQyxDQUFDLENBQUM7S0FDN0IsQ0FBQyxDQUFDO0FBQ0gsVUFBTSxTQUFNLENBQUMsWUFBTTtBQUNqQixZQXBCRyxVQUFVLENBb0JFLENBQUMsQ0FBQyxDQUFDO0tBQ25CLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztBQUNILElBQUUsQ0FBQyxvREFBb0QsRUFBRSxZQUFNO0FBQzdELFVBQU0sU0FBTSxDQUFDLFlBQU07QUFDakIsWUF6QkcsVUFBVSxDQXlCRSxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7S0FDN0IsQ0FBQyxDQUFDO0FBQ0gsVUFBTSxTQUFNLENBQUMsWUFBTTtBQUNqQixZQTVCRyxVQUFVLENBNEJFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztLQUN6QixDQUFDLENBQUM7QUFDSCxVQUFNLFNBQU0sQ0FB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c3Qvc3VicHJvYy1zcGVjcy5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcblxuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBTdWJQcm9jZXNzIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgJ21vY2hhd2FpdCc7XG5pbXBvcnQgeyBnZXRGaXh0dXJlIH0gZnJvbSAnLi9oZWxwZXJzJztcblxuY29uc3Qgc2hvdWxkID0gY2hhaS5zaG91bGQoKTtcbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuZGVzY3JpYmUoJ1N1YlByb2Nlc3MnLCAoKSA9PiB7XG4gIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgaW5pdGlhbGl6ZWQgd2l0aG91dCBhIGNvbW1hbmQnLCAoKSA9PiB7XG4gICAgc2hvdWxkLnRocm93KCgpID0+IHtcbiAgICAgIG5ldyBTdWJQcm9jZXNzKCk7XG4gICAgfSk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIGluaXRpYWxpemVkIHdpdGggYSBiYWQgY29tbWFuZCcsICgpID0+IHtcbiAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgbmV3IFN1YlByb2Nlc3Moe2xvbDogdHJ1ZX0pO1xuICAgIH0pO1xuICAgIHNob3VsZC50aHJvdygoKSA9PiB7XG4gICAgICBuZXcgU3ViUHJvY2VzcygxKTtcbiAgICB9KTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgdGhyb3cgYW4gZXJyb3IgaWYgaW5pdGlhbGl6ZWQgd2l0aCBiYWQgYXJncycsICgpID0+IHtcbiAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgbmV3IFN1YlByb2Nlc3MoJ2xzJywgJ2ZvbycpO1xuICAgIH0pO1xuICAgIHNob3VsZC50aHJvdygoKSA9PiB7XG4gICAgICBuZXcgU3ViUHJvY2VzcygnbHMnLCAxKTtcbiAgICB9KTtcbiAgICBzaG91bGQudGhyb3coKCkgPT4ge1xuICAgICAgbmV3IFN1YlByb2Nlc3MoJ2xzJywge30pO1xuICAgIH0pO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBkZWZhdWx0IGFyZ3MgbGlzdCB0byBbXScsICgpID0+IHtcbiAgICBsZXQgeCA9IG5ldyBTdWJQcm9jZXNzKCdscycpO1xuICAgIHguYXJncy5zaG91bGQuZXFsKFtdKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJyNzdGFydCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGlmIGNvbW1hbmQgZmFpbHMgb24gc3RhcnR1cCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzID0gbmV3IFN1YlByb2Nlc3MoJ2JsYXJnaW1hcmcnKTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0VOT0VOVC8pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgaGF2ZSBhIGRlZmF1bHQgc3RhcnREZXRlY3RvciBvZiB3YWl0aW5nIGZvciBvdXRwdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgaGFzRGF0YSA9IGZhbHNlO1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnbHMnKTtcbiAgICAgIHMub24oJ291dHB1dCcsIChzdGRvdXQpID0+IHtcbiAgICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICAgIGhhc0RhdGEgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBpbnRlcnByZXQgYSBudW1lcmljIHN0YXJ0RGV0ZWN0b3IgYXMgYSBzdGFydCB0aW1lb3V0JywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IGhhc0RhdGEgPSBmYWxzZTtcbiAgICAgIGxldCBzID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgnc2xlZXB5cHJvYy5zaCcpLCBbJ2xzJ10pO1xuICAgICAgcy5vbignb3V0cHV0JywgKHN0ZG91dCkgPT4ge1xuICAgICAgICBpZiAoc3Rkb3V0KSB7XG4gICAgICAgICAgaGFzRGF0YSA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYXdhaXQgcy5zdGFydCgwKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLmZhbHNlO1xuICAgICAgYXdhaXQgQi5kZWxheSgxMjAwKTtcbiAgICAgIGhhc0RhdGEuc2hvdWxkLmJlLnRydWU7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGV2ZW4gd2l0aCBhIHN0YXJ0IHRpbWVvdXQgb2YgMCB3aGVuIGNvbW1hbmQgaXMgYmFkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnYmxhcmdpbWFyZycpO1xuICAgICAgYXdhaXQgcy5zdGFydCgwKS5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0VOT0VOVC8pO1xuICAgIH0pO1xuICAgIGl0KCdzaG91bGQgYmUgYWJsZSB0byBwcm92aWRlIGEgY3VzdG9tIHN0YXJ0RGV0ZWN0b3IgZnVuY3Rpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc2QgPSAoc3Rkb3V0KSA9PiB7IHJldHVybiBzdGRvdXQ7IH07XG4gICAgICBsZXQgaGFzRGF0YSA9IGZhbHNlO1xuICAgICAgbGV0IHMgPSBuZXcgU3ViUHJvY2VzcygnbHMnKTtcbiAgICAgIHMub24oJ291dHB1dCcsIChzdGRvdXQpID0+IHtcbiAgICAgICAgaWYgKHN0ZG91dCkge1xuICAgICAgICAgIGhhc0RhdGEgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGF3YWl0IHMuc3RhcnQoc2QpO1xuICAgICAgaGFzRGF0YS5zaG91bGQuYmUudHJ1ZTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2xpc3RlbmluZyBmb3IgZGF0YScsICgpID0+IHtcbiAgICBsZXQgc3VicHJvYztcbiAgICBpdCgnc2hvdWxkIGdldCBvdXRwdXQgYXMgcGFyYW1zJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgbmV3IFByb21pc2UoYXN5bmMgKHJlc29sdmUpID0+IHtcbiAgICAgICAgc3VicHJvYyA9IG5ldyBTdWJQcm9jZXNzKGdldEZpeHR1cmUoJ3NsZWVweXByb2Muc2gnKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFsnbHMnLCBwYXRoLnJlc29sdmUoX19kaXJuYW1lKV0pO1xuICAgICAgICBzdWJwcm9jLm9uKCdvdXRwdXQnLCAoc3Rkb3V0KSA9PiB7XG4gICAgICAgICAgaWYgKHN0ZG91dCAmJiBzdGRvdXQuaW5kZXhPZignc3VicHJvYy1zcGVjcycpICE9PSAtMSkge1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHN1YnByb2Muc3RhcnQoKTtcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgc3VicHJvYy5zdG9wKCk7XG5cbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlKSA9PiB7XG4gICAgICAgIHN1YnByb2MgPSBuZXcgU3ViUHJvY2VzcyhnZXRGaXh0dXJlKCdlY2hvLnNoJyksIFsnZm9vJywgJ2JhciddKTtcbiAgICAgICAgc3VicHJvYy5vbignb3V0cHV0JywgKHN0ZG91dCwgc3RkZXJyKSA9PiB7XG4gICAgICAgICAgaWYgKHN0ZGVyciAmJiBzdGRlcnIuaW5kZXhPZignYmFyJykgIT09IC0xKSB7XG4gICAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgc3VicHJvYy5zdGFydCgpO1xuICAgICAgfSk7XG4gICAgICBhd2FpdCBzdWJwcm9jLnN0b3AoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgZ2V0IG91dHB1dCBieSBsaW5lcycsIGFzeW5jICgpID0+IHtcbiAgICAgIHN1YnByb2MgPSBuZXcgU3ViUHJvY2VzcygnbHMnLCBbcGF0aC5yZXNvbHZlKF9fZGlybmFtZSldKTtcbiAgICAgIGxldCBsaW5lcyA9IFtdO1xuICAgICAgc3VicHJvYy5vbignbGluZXMtc3Rkb3V0JywgKG5ld0xpbmVzKSA9PiB7XG4gICAgICAgIGxpbmVzID0gbGluZXMuY29uY2F0KG5ld0xpbmVzKTtcbiAgICAgIH0pO1xuICAgICAgYXdhaXQgc3VicHJvYy5zdGFydCgwKTtcbiAgICAgIGF3YWl0IEIuZGVsYXkoNTApO1xuICAgICAgbGluZXMuc2hvdWxkLmVxbChbJ2V4ZWMtc3BlY3MuanMnLCAnZml4dHVyZXMnLCAnaGVscGVycy5qcycsXG4gICAgICAgICAgICAgICAgICAgICAgICAnc3VicHJvYy1zcGVjcy5qcyddKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJyNzdG9wJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgc2VuZCB0aGUgcmlnaHQgc2lnbmFsIHRvIHN0b3AgYSBwcm9jJywgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKGFzeW5jIChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgbGV0IHN1YnByb2MgPSBuZXcgU3ViUHJvY2VzcygndGFpbCcsIFsnLWYnLCBwYXRoLnJlc29sdmUoX19maWxlbmFtZSldKTtcbiAgICAgICAgYXdhaXQgc3VicHJvYy5zdGFydCgpO1xuICAgICAgICBzdWJwcm9jLm9uKCdleGl0JywgKGNvZGUsIHNpZ25hbCkgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBzaWduYWwuc2hvdWxkLmVxdWFsKCdTSUdIVVAnKTtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgc3VicHJvYy5zdG9wKCdTSUdIVVAnKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB0aW1lIG91dCBpZiBzdG9wIGRvZXNudCBjb21wbGV0ZSBmYXN0IGVub3VnaCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGxldCBzdWJwcm9jID0gbmV3IFN1YlByb2Nlc3MoZ2V0Rml4dHVyZSgndHJhcGh1cC5zaCcpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBbJ3RhaWwnLCAnLWYnLCBwYXRoLnJlc29sdmUoX19maWxlbmFtZSldKTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RhcnQoKTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RvcCgnU0lHSFVQJywgMTApXG4gICAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL1Byb2Nlc3MgZGlkbid0IGVuZC8pO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBlcnJvciBpZiB0aGVyZSBpcyBubyBwcm9jZXNzIHRvIHN0b3AnLCBhc3luYyAoKSA9PiB7XG4gICAgICBsZXQgc3VicHJvYyA9IG5ldyBTdWJQcm9jZXNzKCdscycpO1xuICAgICAgYXdhaXQgc3VicHJvYy5zdG9wKCkuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9DYW4ndCBzdG9wLyk7XG4gICAgICBhd2FpdCBzdWJwcm9jLnN0YXJ0KCk7XG4gICAgICBhd2FpdCBCLmRlbGF5KDEwKTtcbiAgICAgIGF3YWl0IHN1YnByb2Muc3RvcCgpLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvQ2FuJ3Qgc3RvcC8pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl19