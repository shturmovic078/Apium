'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

var _this = this;

var _ = require('../..');

var _2 = _interopRequireDefault(_);

var _libInstall = require('../lib/install');

var _chai = require('chai');

var _chai2 = _interopRequireDefault(_chai);

var _chaiAsPromised = require('chai-as-promised');

var _chaiAsPromised2 = _interopRequireDefault(_chaiAsPromised);

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _psNode = require('ps-node');

var _psNode2 = _interopRequireDefault(_psNode);

require('mochawait');

require('source-map-support').install();

var should = _chai2['default'].should();
_chai2['default'].use(_chaiAsPromised2['default']);

function nextState(cd) {
  var d = _q2['default'].defer();
  cd.on(_2['default'].EVENT_CHANGED, function (msg) {
    d.resolve(msg.state);
  });
  return d.promise;
}

function nextError(cd) {
  var d = _q2['default'].defer();
  cd.on(_2['default'].EVENT_ERROR, function (err) {
    d.resolve(err);
  });
  return d.promise;
}

function assertNoRunningChromedrivers() {
  var res;
  return _regeneratorRuntime.async(function assertNoRunningChromedrivers$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(_q2['default'].nfcall(_psNode2['default'].lookup, { command: /([^ ]*)chromedriver$/,
          psargs: 'aux' }));

      case 2:
        res = context$1$0.sent;

        res.should.have.length(0);

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function buildReqRes(url, method, body) {
  var req = { originalUrl: url, method: method, body: body };
  var res = {};
  res.headers = {};
  res.set = function (k, v) {
    res[k] = v;
  };
  res.status = function (code) {
    res.sentCode = code;
    return {
      send: function send(body) {
        try {
          body = JSON.parse(body);
        } catch (e) {}
        res.sentBody = body;
      }
    };
  };
  return [req, res];
}

describe('chromedriver binary setup', function () {
  before(function callee$1$0() {
    var cd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd = new _2['default']();
          context$2$0.prev = 1;
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 4:
          context$2$0.next = 11;
          break;

        case 6:
          context$2$0.prev = 6;
          context$2$0.t0 = context$2$0['catch'](1);

          if (!(context$2$0.t0.message.indexOf('Trying to use') !== -1)) {
            context$2$0.next = 11;
            break;
          }

          context$2$0.next = 11;
          return _regeneratorRuntime.awrap((0, _libInstall.install)());

        case 11:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this, [[1, 6]]);
  });

  it('should start with a binary that exists', function callee$1$0() {
    var cd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd = new _2['default']();
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.initChromedriverPath());

        case 3:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('chromedriver with EventEmitter', function () {
  var cd = null;
  var caps = { browserName: 'chrome' };
  before(function callee$1$0() {
    var opts;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          opts = {};

          cd = new _2['default'](opts);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should start a session', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql('stopped');
          nextStatePromise = nextState(cd);

          cd.start(caps);
          cd.capabilities.should.eql(caps);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STARTING));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 8:
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should run some commands', function callee$1$0() {
    var res;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(cd.sendCommand('/url', 'POST', { url: 'http://google.com' }));

        case 2:
          res = context$2$0.sent;

          should.not.exist(res);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(cd.sendCommand('/url', 'GET'));

        case 6:
          res = context$2$0.sent;

          res.should.contain('google');

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should proxy commands', function callee$1$0() {
    var initSessId, _buildReqRes, _buildReqRes2, req, res;

    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          initSessId = cd.sessionId();
          _buildReqRes = buildReqRes('/url', 'GET');
          _buildReqRes2 = _slicedToArray(_buildReqRes, 2);
          req = _buildReqRes2[0];
          res = _buildReqRes2[1];
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(cd.proxyReq(req, res));

        case 7:
          res.headers['content-type'].should.contain('application/json');
          res.sentCode.should.equal(200);
          res.sentBody.status.should.equal(0);
          res.sentBody.value.should.contain('google');
          res.sentBody.sessionId.should.equal(initSessId);

        case 12:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should say whether there is a working webview', function callee$1$0() {
    var res;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          context$2$0.next = 2;
          return _regeneratorRuntime.awrap(cd.hasWorkingWebview());

        case 2:
          res = context$2$0.sent;

          res.should.equal(true);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should restart a session', function callee$1$0() {
    var p1;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          p1 = nextState(cd);

          cd.restart();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(p1.should.become(_2['default'].STATE_STOPPING));

        case 4:
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_STOPPED));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should stop a session', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          nextStatePromise = nextState(cd);

          cd.stop();
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STOPPING));

        case 4:
          should.not.exist(cd.sessionId());
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_STOPPED));

        case 7:
          should.not.exist(cd.sessionId());
          context$2$0.next = 10;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 10:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it.skip('should change state to stopped if chromedriver crashes', function callee$1$0() {
    var nextStatePromise;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          // test works but is skipped because it leaves a chrome window orphaned
          // and I can't figure out a way to safely kill only that one
          cd.state.should.eql(_2['default'].STATE_STOPPED);
          nextStatePromise = nextState(cd);

          cd.start(caps);
          cd.capabilities.should.eql(caps);
          context$2$0.next = 6;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STARTING));

        case 6:
          context$2$0.next = 8;
          return _regeneratorRuntime.awrap(nextState(cd).should.become(_2['default'].STATE_ONLINE));

        case 8:
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());
          nextStatePromise = nextState(cd);
          context$2$0.next = 13;
          return _regeneratorRuntime.awrap(cd.killAll());

        case 13:
          context$2$0.next = 15;
          return _regeneratorRuntime.awrap(nextStatePromise.should.become(_2['default'].STATE_STOPPED));

        case 15:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error when chromedriver doesnt exist', function callee$1$0() {
    var cd2, nextErrP, err;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd2 = new _2['default']({ executable: '/does/not/exist' });
          nextErrP = nextError(cd2);

          cd2.start({});
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(nextErrP);

        case 5:
          err = context$2$0.sent;

          err.message.should.contain('Trying to use');

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

describe('chromedriver with asyncawait', function () {
  var cd = null;
  var caps = { browserName: 'chrome' };
  before(function callee$1$0() {
    var opts;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          opts = {};

          cd = new _2['default'](opts);

        case 2:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should start a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql('stopped');
          should.not.exist(cd.sessionId());
          context$2$0.next = 4;
          return _regeneratorRuntime.awrap(cd.start(caps));

        case 4:
          cd.capabilities.should.eql(caps);
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          should.exist(cd.jwproxy.sessionId);
          should.exist(cd.sessionId());

        case 8:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should restart a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.restart());

        case 3:
          cd.state.should.eql(_2['default'].STATE_ONLINE);

        case 4:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should stop a session', function callee$1$0() {
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          cd.state.should.eql(_2['default'].STATE_ONLINE);
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(cd.stop());

        case 3:
          cd.state.should.eql(_2['default'].STATE_STOPPED);
          should.not.exist(cd.sessionId());
          context$2$0.next = 7;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 7:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error during start if spawn doesnt work', function callee$1$0() {
    var badCd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          badCd = new _2['default']({ port: 1 });
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(badCd.start(caps).should.eventually.be.rejectedWith('Could not proxy'));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
  it('should throw an error during start if session doesnt work', function callee$1$0() {
    var badCd;
    return _regeneratorRuntime.async(function callee$1$0$(context$2$0) {
      while (1) switch (context$2$0.prev = context$2$0.next) {
        case 0:
          badCd = new _2['default']();
          context$2$0.next = 3;
          return _regeneratorRuntime.awrap(badCd.start({ chromeOptions: { badCap: 'foo' } }).should.eventually.be.rejectedWith('cannot parse capability'));

        case 3:
          context$2$0.next = 5;
          return _regeneratorRuntime.awrap(assertNoRunningChromedrivers());

        case 5:
        case 'end':
          return context$2$0.stop();
      }
    }, null, _this);
  });
});

// we miss the opportunity to listen for the 'starting' state
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvY2hyb21lZHJpdmVyLXNwZWNzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Z0JBRXlCLE9BQU87Ozs7MEJBQ1IsZ0JBQWdCOztvQkFDdkIsTUFBTTs7Ozs4QkFDSSxrQkFBa0I7Ozs7aUJBQy9CLEdBQUc7Ozs7c0JBQ0UsU0FBUzs7OztRQUNyQixXQUFXOztBQVJsQixPQUFPLENBQUMsb0JBQW9CLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQzs7QUFVeEMsSUFBSSxNQUFNLEdBQUcsa0JBQUssTUFBTSxFQUFFLENBQUM7QUFDM0Isa0JBQUssR0FBRyw2QkFBZ0IsQ0FBQzs7QUFFekIsU0FBUyxTQUFTLENBQUUsRUFBRSxFQUFFO0FBQ3RCLE1BQUksQ0FBQyxHQUFHLGVBQUUsS0FBSyxFQUFFLENBQUM7QUFDbEIsSUFBRSxDQUFDLEVBQUUsQ0FBQyxjQUFhLGFBQWEsRUFBRSxVQUFBLEdBQUcsRUFBSTtBQUN2QyxLQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztHQUN0QixDQUFDLENBQUM7QUFDSCxTQUFPLENBQUMsQ0FBQyxPQUFPLENBQUM7Q0FDbEI7O0FBRUQsU0FBUyxTQUFTLENBQUUsRUFBRSxFQUFFO0FBQ3RCLE1BQUksQ0FBQyxHQUFHLGVBQUUsS0FBSyxFQUFFLENBQUM7QUFDbEIsSUFBRSxDQUFDLEVBQUUsQ0FBQyxjQUFhLFdBQVcsRUFBRSxVQUFBLEdBQUcsRUFBSTtBQUNyQyxLQUFDLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0dBQ2hCLENBQUMsQ0FBQztBQUNILFNBQU8sQ0FBQyxDQUFDLE9BQU8sQ0FBQztDQUNsQjs7QUFFRCxTQUFlLDRCQUE0QjtNQUNyQyxHQUFHOzs7Ozt5Q0FBUyxlQUFFLE1BQU0sQ0FBQyxvQkFBTyxNQUFNLEVBQUUsRUFBQyxPQUFPLEVBQUUsc0JBQXNCO0FBQy9CLGdCQUFNLEVBQUUsS0FBSyxFQUFDLENBQUM7OztBQURwRCxXQUFHOztB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ZXNDb250ZW50IjpbInJlcXVpcmUoJ3NvdXJjZS1tYXAtc3VwcG9ydCcpLmluc3RhbGwoKTtcblxuaW1wb3J0IENocm9tZWRyaXZlciBmcm9tICcuLi8uLic7XG5pbXBvcnQgeyBpbnN0YWxsIH0gZnJvbSAnLi4vbGliL2luc3RhbGwnO1xuaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgY2hhaUFzUHJvbWlzZWQgZnJvbSAnY2hhaS1hcy1wcm9taXNlZCc7XG5pbXBvcnQgUSBmcm9tICdxJztcbmltcG9ydCBwc05vZGUgZnJvbSAncHMtbm9kZSc7XG5pbXBvcnQgJ21vY2hhd2FpdCc7XG5cbmxldCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBuZXh0U3RhdGUgKGNkKSB7XG4gIGxldCBkID0gUS5kZWZlcigpO1xuICBjZC5vbihDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCwgbXNnID0+IHtcbiAgICBkLnJlc29sdmUobXNnLnN0YXRlKTtcbiAgfSk7XG4gIHJldHVybiBkLnByb21pc2U7XG59XG5cbmZ1bmN0aW9uIG5leHRFcnJvciAoY2QpIHtcbiAgbGV0IGQgPSBRLmRlZmVyKCk7XG4gIGNkLm9uKENocm9tZWRyaXZlci5FVkVOVF9FUlJPUiwgZXJyID0+IHtcbiAgICBkLnJlc29sdmUoZXJyKTtcbiAgfSk7XG4gIHJldHVybiBkLnByb21pc2U7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGFzc2VydE5vUnVubmluZ0Nocm9tZWRyaXZlcnMgKCkge1xuICBsZXQgcmVzID0gYXdhaXQgUS5uZmNhbGwocHNOb2RlLmxvb2t1cCwge2NvbW1hbmQ6IC8oW14gXSopY2hyb21lZHJpdmVyJC8sXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcHNhcmdzOiAnYXV4J30pO1xuICByZXMuc2hvdWxkLmhhdmUubGVuZ3RoKDApO1xufVxuXG5mdW5jdGlvbiBidWlsZFJlcVJlcyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgbGV0IHJlcSA9IHtvcmlnaW5hbFVybDogdXJsLCBtZXRob2QsIGJvZHl9O1xuICBsZXQgcmVzID0ge307XG4gIHJlcy5oZWFkZXJzID0ge307XG4gIHJlcy5zZXQgPSAoaywgdikgPT4geyByZXNba10gPSB2OyB9O1xuICByZXMuc3RhdHVzID0gKGNvZGUpID0+IHtcbiAgICByZXMuc2VudENvZGUgPSBjb2RlO1xuICAgIHJldHVybiB7XG4gICAgICBzZW5kOiAoYm9keSkgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGJvZHkgPSBKU09OLnBhcnNlKGJvZHkpO1xuICAgICAgICB9IGNhdGNoIChlKSB7fVxuICAgICAgICByZXMuc2VudEJvZHkgPSBib2R5O1xuICAgICAgfVxuICAgIH07XG4gIH07XG4gIHJldHVybiBbcmVxLCByZXNdO1xufVxuXG5kZXNjcmliZSgnY2hyb21lZHJpdmVyIGJpbmFyeSBzZXR1cCcsICgpID0+IHtcbiAgYmVmb3JlKGFzeW5jICgpID0+IHtcbiAgICBsZXQgY2QgPSBuZXcgQ2hyb21lZHJpdmVyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGNkLmluaXRDaHJvbWVkcml2ZXJQYXRoKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoZXJyLm1lc3NhZ2UuaW5kZXhPZihcIlRyeWluZyB0byB1c2VcIikgIT09IC0xKSB7XG4gICAgICAgIGF3YWl0IGluc3RhbGwoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgc3RhcnQgd2l0aCBhIGJpbmFyeSB0aGF0IGV4aXN0cycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgY2QgPSBuZXcgQ2hyb21lZHJpdmVyKCk7XG4gICAgYXdhaXQgY2QuaW5pdENocm9tZWRyaXZlclBhdGgoKTtcbiAgfSk7XG59KTtcblxuZGVzY3JpYmUoJ2Nocm9tZWRyaXZlciB3aXRoIEV2ZW50RW1pdHRlcicsICgpID0+IHtcbiAgbGV0IGNkID0gbnVsbDtcbiAgY29uc3QgY2FwcyA9IHticm93c2VyTmFtZTogJ2Nocm9tZSd9O1xuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIGxldCBvcHRzID0ge307XG4gICAgY2QgPSBuZXcgQ2hyb21lZHJpdmVyKG9wdHMpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBzdGFydCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbCgnc3RvcHBlZCcpO1xuICAgIGxldCBuZXh0U3RhdGVQcm9taXNlID0gbmV4dFN0YXRlKGNkKTtcbiAgICBjZC5zdGFydChjYXBzKTtcbiAgICBjZC5jYXBhYmlsaXRpZXMuc2hvdWxkLmVxbChjYXBzKTtcbiAgICBhd2FpdCBuZXh0U3RhdGVQcm9taXNlLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUQVJUSU5HKTtcbiAgICBhd2FpdCBuZXh0U3RhdGUoY2QpLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLmp3cHJveHkuc2Vzc2lvbklkKTtcbiAgICBzaG91bGQuZXhpc3QoY2Quc2Vzc2lvbklkKCkpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBydW4gc29tZSBjb21tYW5kcycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgcmVzID0gYXdhaXQgY2Quc2VuZENvbW1hbmQoJy91cmwnLCAnUE9TVCcsIHt1cmw6ICdodHRwOi8vZ29vZ2xlLmNvbSd9KTtcbiAgICBzaG91bGQubm90LmV4aXN0KHJlcyk7XG4gICAgcmVzID0gYXdhaXQgY2Quc2VuZENvbW1hbmQoJy91cmwnLCAnR0VUJyk7XG4gICAgcmVzLnNob3VsZC5jb250YWluKCdnb29nbGUnKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgcHJveHkgY29tbWFuZHMnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGluaXRTZXNzSWQgPSBjZC5zZXNzaW9uSWQoKTtcbiAgICBsZXQgW3JlcSwgcmVzXSA9IGJ1aWxkUmVxUmVzKCcvdXJsJywgJ0dFVCcpO1xuICAgIGF3YWl0IGNkLnByb3h5UmVxKHJlcSwgcmVzKTtcbiAgICByZXMuaGVhZGVyc1snY29udGVudC10eXBlJ10uc2hvdWxkLmNvbnRhaW4oJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICByZXMuc2VudENvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgcmVzLnNlbnRCb2R5LnN0YXR1cy5zaG91bGQuZXF1YWwoMCk7XG4gICAgcmVzLnNlbnRCb2R5LnZhbHVlLnNob3VsZC5jb250YWluKCdnb29nbGUnKTtcbiAgICByZXMuc2VudEJvZHkuc2Vzc2lvbklkLnNob3VsZC5lcXVhbChpbml0U2Vzc0lkKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc2F5IHdoZXRoZXIgdGhlcmUgaXMgYSB3b3JraW5nIHdlYnZpZXcnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHJlcyA9IGF3YWl0IGNkLmhhc1dvcmtpbmdXZWJ2aWV3KCk7XG4gICAgcmVzLnNob3VsZC5lcXVhbCh0cnVlKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgcmVzdGFydCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IHAxID0gbmV4dFN0YXRlKGNkKTtcbiAgICBjZC5yZXN0YXJ0KCk7XG4gICAgYXdhaXQgcDEuc2hvdWxkLmJlY29tZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBJTkcpO1xuICAgIGF3YWl0IG5leHRTdGF0ZShjZCkuc2hvdWxkLmJlY29tZShDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCk7XG4gICAgLy8gd2UgbWlzcyB0aGUgb3Bwb3J0dW5pdHkgdG8gbGlzdGVuIGZvciB0aGUgJ3N0YXJ0aW5nJyBzdGF0ZVxuICAgIGF3YWl0IG5leHRTdGF0ZShjZCkuc2hvdWxkLmJlY29tZShDaHJvbWVkcml2ZXIuU1RBVEVfT05MSU5FKTtcbiAgfSk7XG4gIGl0KCdzaG91bGQgc3RvcCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IG5leHRTdGF0ZVByb21pc2UgPSBuZXh0U3RhdGUoY2QpO1xuICAgIGNkLnN0b3AoKTtcbiAgICBhd2FpdCBuZXh0U3RhdGVQcm9taXNlLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQSU5HKTtcbiAgICBzaG91bGQubm90LmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgICBhd2FpdCBuZXh0U3RhdGUoY2QpLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgIHNob3VsZC5ub3QuZXhpc3QoY2Quc2Vzc2lvbklkKCkpO1xuICAgIGF3YWl0IGFzc2VydE5vUnVubmluZ0Nocm9tZWRyaXZlcnMoKTtcbiAgfSk7XG4gIGl0LnNraXAoJ3Nob3VsZCBjaGFuZ2Ugc3RhdGUgdG8gc3RvcHBlZCBpZiBjaHJvbWVkcml2ZXIgY3Jhc2hlcycsIGFzeW5jICgpID0+IHtcbiAgICAvLyB0ZXN0IHdvcmtzIGJ1dCBpcyBza2lwcGVkIGJlY2F1c2UgaXQgbGVhdmVzIGEgY2hyb21lIHdpbmRvdyBvcnBoYW5lZFxuICAgIC8vIGFuZCBJIGNhbid0IGZpZ3VyZSBvdXQgYSB3YXkgdG8gc2FmZWx5IGtpbGwgb25seSB0aGF0IG9uZVxuICAgIGNkLnN0YXRlLnNob3VsZC5lcWwoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICAgIGxldCBuZXh0U3RhdGVQcm9taXNlID0gbmV4dFN0YXRlKGNkKTtcbiAgICBjZC5zdGFydChjYXBzKTtcbiAgICBjZC5jYXBhYmlsaXRpZXMuc2hvdWxkLmVxbChjYXBzKTtcbiAgICBhd2FpdCBuZXh0U3RhdGVQcm9taXNlLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUQVJUSU5HKTtcbiAgICBhd2FpdCBuZXh0U3RhdGUoY2QpLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLmp3cHJveHkuc2Vzc2lvbklkKTtcbiAgICBzaG91bGQuZXhpc3QoY2Quc2Vzc2lvbklkKCkpO1xuICAgIG5leHRTdGF0ZVByb21pc2UgPSBuZXh0U3RhdGUoY2QpO1xuICAgIGF3YWl0IGNkLmtpbGxBbGwoKTtcbiAgICBhd2FpdCBuZXh0U3RhdGVQcm9taXNlLnNob3VsZC5iZWNvbWUoQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCB0aHJvdyBhbiBlcnJvciB3aGVuIGNocm9tZWRyaXZlciBkb2VzbnQgZXhpc3QnLCBhc3luYyAoKSA9PiB7XG4gICAgbGV0IGNkMiA9IG5ldyBDaHJvbWVkcml2ZXIoe2V4ZWN1dGFibGU6ICcvZG9lcy9ub3QvZXhpc3QnfSk7XG4gICAgbGV0IG5leHRFcnJQID0gbmV4dEVycm9yKGNkMik7XG4gICAgY2QyLnN0YXJ0KHt9KTtcbiAgICBsZXQgZXJyID0gYXdhaXQgbmV4dEVyclA7XG4gICAgZXJyLm1lc3NhZ2Uuc2hvdWxkLmNvbnRhaW4oJ1RyeWluZyB0byB1c2UnKTtcbiAgfSk7XG59KTtcblxuXG5kZXNjcmliZSgnY2hyb21lZHJpdmVyIHdpdGggYXN5bmNhd2FpdCcsICgpID0+IHtcbiAgbGV0IGNkID0gbnVsbDtcbiAgY29uc3QgY2FwcyA9IHticm93c2VyTmFtZTogJ2Nocm9tZSd9O1xuICBiZWZvcmUoYXN5bmMgKCkgPT4ge1xuICAgIGxldCBvcHRzID0ge307XG4gICAgY2QgPSBuZXcgQ2hyb21lZHJpdmVyKG9wdHMpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBzdGFydCBhIHNlc3Npb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY2Quc3RhdGUuc2hvdWxkLmVxbCgnc3RvcHBlZCcpO1xuICAgIHNob3VsZC5ub3QuZXhpc3QoY2Quc2Vzc2lvbklkKCkpO1xuICAgIGF3YWl0IGNkLnN0YXJ0KGNhcHMpO1xuICAgIGNkLmNhcGFiaWxpdGllcy5zaG91bGQuZXFsKGNhcHMpO1xuICAgIGNkLnN0YXRlLnNob3VsZC5lcWwoQ2hyb21lZHJpdmVyLlNUQVRFX09OTElORSk7XG4gICAgc2hvdWxkLmV4aXN0KGNkLmp3cHJveHkuc2Vzc2lvbklkKTtcbiAgICBzaG91bGQuZXhpc3QoY2Quc2Vzc2lvbklkKCkpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCByZXN0YXJ0IGEgc2Vzc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICAgIGF3YWl0IGNkLnJlc3RhcnQoKTtcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICB9KTtcbiAgaXQoJ3Nob3VsZCBzdG9wIGEgc2Vzc2lvbicsIGFzeW5jICgpID0+IHtcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9PTkxJTkUpO1xuICAgIGF3YWl0IGNkLnN0b3AoKTtcbiAgICBjZC5zdGF0ZS5zaG91bGQuZXFsKENocm9tZWRyaXZlci5TVEFURV9TVE9QUEVEKTtcbiAgICBzaG91bGQubm90LmV4aXN0KGNkLnNlc3Npb25JZCgpKTtcbiAgICBhd2FpdCBhc3NlcnROb1J1bm5pbmdDaHJvbWVkcml2ZXJzKCk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGR1cmluZyBzdGFydCBpZiBzcGF3biBkb2VzbnQgd29yaycsIGFzeW5jICgpID0+IHtcbiAgICBsZXQgYmFkQ2QgPSBuZXcgQ2hyb21lZHJpdmVyKHtwb3J0OiAxfSk7XG4gICAgYXdhaXQgYmFkQ2Quc3RhcnQoY2Fwcykuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKCdDb3VsZCBub3QgcHJveHknKTtcbiAgICBhd2FpdCBhc3NlcnROb1J1bm5pbmdDaHJvbWVkcml2ZXJzKCk7XG4gIH0pO1xuICBpdCgnc2hvdWxkIHRocm93IGFuIGVycm9yIGR1cmluZyBzdGFydCBpZiBzZXNzaW9uIGRvZXNudCB3b3JrJywgYXN5bmMgKCkgPT4ge1xuICAgIGxldCBiYWRDZCA9IG5ldyBDaHJvbWVkcml2ZXIoKTtcbiAgICBhd2FpdCBiYWRDZC5zdGFydCh7Y2hyb21lT3B0aW9uczoge2JhZENhcDogJ2Zvbyd9fSlcbiAgICAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoJ2Nhbm5vdCBwYXJzZSBjYXBhYmlsaXR5Jyk7XG4gICAgYXdhaXQgYXNzZXJ0Tm9SdW5uaW5nQ2hyb21lZHJpdmVycygpO1xuICB9KTtcbn0pO1xuIl19