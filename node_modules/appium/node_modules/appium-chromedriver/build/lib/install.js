'use strict';

var _slicedToArray = require('babel-runtime/helpers/sliced-to-array')['default'];

var _Object$defineProperty = require('babel-runtime/core-js/object/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

_Object$defineProperty(exports, '__esModule', {
  value: true
});

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _appiumSupport = require('appium-support');

var _appiumSupport2 = _interopRequireDefault(_appiumSupport);

var _appiumLogger = require('appium-logger');

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _requestPromise = require('request-promise');

var _requestPromise2 = _interopRequireDefault(_requestPromise);

var _admZip = require('adm-zip');

var _admZip2 = _interopRequireDefault(_admZip);

var _asyncbox = require('asyncbox');

var _utils = require('./utils');

var system = _appiumSupport2['default'].system;
var tempDir = _appiumSupport2['default'].tempDir;
var util = _appiumSupport2['default'].util;

var log = (0, _appiumLogger.getLogger)('Chromedriver Install');

var CD_VER = process.env.npm_config_chromedriver_version || '2.15';
var CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'http://chromedriver.storage.googleapis.com';
var CD_BASE_DIR = _path2['default'].resolve(__dirname, '..', '..', 'chromedriver');
var CD_PLATS = ['linux', 'win', 'mac'];
var CD_ARCHS = ['32', '64'];

var getCurArch = _q2['default'].denodeify(system.arch);
var writeFile = _q2['default'].denodeify(_fs2['default'].writeFile);
var readFile = _q2['default'].denodeify(_fs2['default'].readFile);
var mkdir = _q2['default'].denodeify(_fs2['default'].mkdir);
var chmod = _q2['default'].denodeify(_fs2['default'].chmod);
var mkdirp = util.mkdirp;

function getCurPlatform() {
  return system.isWindows() ? 'win' : system.isMac() ? 'mac' : 'linux';
}

function getChromedriverDir() {
  var platform = arguments[0] === undefined ? null : arguments[0];

  if (!platform) {
    platform = getCurPlatform();
  }
  return _path2['default'].resolve(CD_BASE_DIR, platform);
}

function getChromedriverBinaryPath() {
  var platform = arguments[0] === undefined ? null : arguments[0];
  var arch = arguments[1] === undefined ? null : arguments[1];
  var baseDir, ext;
  return _regeneratorRuntime.async(function getChromedriverBinaryPath$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!platform) {
          platform = getCurPlatform();
        }
        baseDir = getChromedriverDir(platform);
        ext = '';

        if (!(platform === 'win')) {
          context$1$0.next = 7;
          break;
        }

        ext = '.exe';
        context$1$0.next = 13;
        break;

      case 7:
        if (!(platform === 'linux')) {
          context$1$0.next = 13;
          break;
        }

        if (arch) {
          context$1$0.next = 12;
          break;
        }

        context$1$0.next = 11;
        return _regeneratorRuntime.awrap(getCurArch());

      case 11:
        arch = context$1$0.sent;

      case 12:
        ext = '_' + arch;

      case 13:
        return context$1$0.abrupt('return', _path2['default'].resolve(baseDir, 'chromedriver' + ext));

      case 14:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDownloadUrl(version, platform, arch) {
  return '' + CD_CDN + '/' + version + '/chromedriver_' + platform + '' + arch + '.zip';
}

function validatePlatform(platform, arch) {
  if (!_lodash2['default'].contains(CD_PLATS, platform)) {
    throw new Error('Invalid platform: ' + platform);
  }
  if (!_lodash2['default'].contains(CD_ARCHS, arch)) {
    throw new Error('Invalid arch: ' + arch);
  }
  if (arch === '64' && platform !== 'linux') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

function installForPlatform(version, platform, arch) {
  var url, binarySpec, tempFile, body, tempUnzipped, zip, extractedBin, newBin, binContents;
  return _regeneratorRuntime.async(function installForPlatform$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        validatePlatform(platform, arch);
        url = getDownloadUrl(version, platform, arch);
        binarySpec = 'chromedriver_' + platform + '' + arch;

        log.info('Opening temp file to write ' + binarySpec + ' to...');
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(tempDir.open({
          prefix: binarySpec,
          suffix: '.zip'
        }));

      case 6:
        tempFile = context$1$0.sent;

        // actually download the zipfile and write it with appropriate perms
        log.info('Downloading ' + url + '...');
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(_requestPromise2['default'].get({ url: url, encoding: 'binary' }));

      case 10:
        body = context$1$0.sent;

        log.info('Writing binary content to ' + tempFile.path + '...');
        context$1$0.next = 14;
        return _regeneratorRuntime.awrap(writeFile(tempFile.path, body, { encoding: 'binary' }));

      case 14:
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(chmod(tempFile.path, 420));

      case 16:
        tempUnzipped = _path2['default'].resolve(_path2['default'].dirname(tempFile.path), binarySpec);

        log.info('Extracting ' + tempFile.path + ' to ' + tempUnzipped);
        context$1$0.next = 20;
        return _regeneratorRuntime.awrap(mkdir(tempUnzipped));

      case 20:
        zip = new _admZip2['default'](tempFile.path);

        zip.extractAllTo(tempUnzipped, true);
        extractedBin = _path2['default'].resolve(tempUnzipped, 'chromedriver');

        if (platform === 'win') {
          extractedBin += '.exe';
        }

        // make build dirs that will hold the chromedriver binary
        log.info('Creating ' + _path2['default'].resolve(CD_BASE_DIR, platform) + '...');
        context$1$0.next = 27;
        return _regeneratorRuntime.awrap(mkdirp(CD_BASE_DIR));

      case 27:
        context$1$0.next = 29;
        return _regeneratorRuntime.awrap(mkdirp(_path2['default'].resolve(CD_BASE_DIR, platform)));

      case 29:
        context$1$0.next = 31;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 31:
        newBin = context$1$0.sent;

        log.info('Copying unzipped binary, reading from ' + extractedBin + '...');
        context$1$0.next = 35;
        return _regeneratorRuntime.awrap(readFile(extractedBin, { encoding: 'binary' }));

      case 35:
        binContents = context$1$0.sent;

        log.info('Writing to ' + newBin + '...');
        context$1$0.next = 39;
        return _regeneratorRuntime.awrap(writeFile(newBin, binContents, { encoding: 'binary', mode: 493 }));

      case 39:
        log.info('' + newBin + ' successfully put in place');

      case 40:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function install() {
  var arch, platform;
  return _regeneratorRuntime.async(function install$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getCurArch());

      case 2:
        arch = context$1$0.sent;
        platform = getCurPlatform();

        if (platform !== 'linux' && arch === '64') {
          arch = '32';
        }
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function conditionalInstall() {
  var arch, platform, binPath;
  return _regeneratorRuntime.async(function conditionalInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(getCurArch());

      case 2:
        arch = context$1$0.sent;
        platform = getCurPlatform();

        if (platform !== 'linux' && arch === '64') {
          arch = '32';
        }
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(getChromedriverBinaryPath(platform, arch));

      case 7:
        binPath = context$1$0.sent;
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap((0, _utils.exists)(binPath));

      case 10:
        if (context$1$0.sent) {
          context$1$0.next = 15;
          break;
        }

        context$1$0.next = 13;
        return _regeneratorRuntime.awrap(installForPlatform(CD_VER, platform, arch));

      case 13:
        context$1$0.next = 16;
        break;

      case 15:
        log.info('No need to install chromedriver, ' + binPath + ' exists');

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function installAll() {
  var plats, downloads, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, _step$value, platform, arch;

  return _regeneratorRuntime.async(function installAll$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        plats = [['linux', '32'], ['linux', '64'], ['win', '32'], ['mac', '32']];
        downloads = [];
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 5;

        for (_iterator = _getIterator(plats); !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          _step$value = _slicedToArray(_step.value, 2);
          platform = _step$value[0];
          arch = _step$value[1];

          downloads.push(installForPlatform(CD_VER, platform, arch));
        }
        context$1$0.next = 13;
        break;

      case 9:
        context$1$0.prev = 9;
        context$1$0.t0 = context$1$0['catch'](5);
        _didIteratorError = true;
        _iteratorError = context$1$0.t0;

      case 13:
        context$1$0.prev = 13;
        context$1$0.prev = 14;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 16:
        context$1$0.prev = 16;

        if (!_didIteratorError) {
          context$1$0.next = 19;
          break;
        }

        throw _iteratorError;

      case 19:
        return context$1$0.finish(16);

      case 20:
        return context$1$0.finish(13);

      case 21:
        context$1$0.next = 23;
        return _regeneratorRuntime.awrap((0, _asyncbox.parallel)(downloads));

      case 23:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[5, 9, 13, 21], [14,, 16, 20]]);
}

function doInstall() {
  return _regeneratorRuntime.async(function doInstall$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!_lodash2['default'].contains(process.argv, '--all')) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(installAll());

      case 3:
        context$1$0.next = 12;
        break;

      case 5:
        if (!_lodash2['default'].contains(process.argv, '--conditional')) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(conditionalInstall());

      case 8:
        context$1$0.next = 12;
        break;

      case 10:
        context$1$0.next = 12;
        return _regeneratorRuntime.awrap(install());

      case 12:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

exports.getChromedriverBinaryPath = getChromedriverBinaryPath;
exports.install = install;
exports.installAll = installAll;
exports.CD_BASE_DIR = CD_BASE_DIR;
exports.getCurPlatform = getCurPlatform;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

// set up a temp file to download the chromedriver zipfile to

// extract downloaded zipfile to tempdir

// copy the extracted binary to the correct build dir
//# sourceMappingURL=data:application/json;base64,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QUVELFNBQWUsVUFBVTtNQUNqQixLQUFLLEVBTVAsU0FBUywrRkFDSCxRQUFRLEVBQUUsSUFBSTs7Ozs7QUFQbEIsYUFBSyxHQUFHLENBQ1osQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQ2YsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQ2YsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQ2IsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQ2Q7QUFDRyxpQkFBUyxHQUFHLEVBQUU7Ozs7OztBQUNsQixzQ0FBNkIsS0FBSyxxR0FBRTs7QUFBMUIsa0JBQVE7QUFBRSxjQUFJOztBQUN0QixtQkFBUyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDNUQ7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozt5Q0FDSyxjQTVJQyxRQUFRLEVBNElOLFNBQVMsQ0FBQzs7Ozs7OztDQUNwQjs7QUFFRCxTQUFlLFNBQVM7Ozs7YUFDbEIsb0JBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDOzs7Ozs7eUNBQzdCLFVBQVUsRUFBRTs7Ozs7OzthQUNULG9CQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQzs7Ozs7O3lDQUM1QyxrQkFBa0IsRUFBRTs7Ozs7Ozs7eUNBRXBCLE9BQU8sRUFBRTs7Ozs7OztDQUVsQjs7UUFFUSx5QkFBeUIsR0FBekIseUJBQXlCO1FBQUUsT0FBTyxHQUFQLE9BQU87UUFBRSxVQUFVLEdBQVYsVUFBVTtRQUFFLFdBQVcsR0FBWCxXQUFXO1FBQzNELGNBQWMsR0FBZCxjQUFjO1FBQUUsa0JBQWtCLEdBQWxCLGtCQUFrQjtRQUFFLFNBQVMsR0FBVCxTQUFTIiwiZmlsZSI6ImxpYi9pbnN0YWxsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGZzIGZyb20gJ2ZzJztcbmltcG9ydCBzdXBwb3J0IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGdldExvZ2dlciB9IGZyb20gJ2FwcGl1bS1sb2dnZXInO1xuaW1wb3J0IFEgZnJvbSAncSc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IEFkbVppcCBmcm9tICdhZG0temlwJztcbmltcG9ydCB7IHBhcmFsbGVsIGFzIGxsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgZXhpc3RzIH0gZnJvbSAnLi91dGlscyc7XG5jb25zdCB7IHN5c3RlbSwgdGVtcERpciwgdXRpbCB9ID0gc3VwcG9ydDtcbmNvbnN0IGxvZyA9IGdldExvZ2dlcignQ2hyb21lZHJpdmVyIEluc3RhbGwnKTtcblxuY29uc3QgQ0RfVkVSID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfdmVyc2lvbiB8fCBcIjIuMTVcIjtcbmNvbnN0IENEX0NETiA9IHByb2Nlc3MuZW52Lm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2NkbnVybCB8fFxuICAgICAgICAgICAgICAgcHJvY2Vzcy5lbnYuQ0hST01FRFJJVkVSX0NETlVSTCB8fFxuICAgICAgICAgICAgICAgXCJodHRwOi8vY2hyb21lZHJpdmVyLnN0b3JhZ2UuZ29vZ2xlYXBpcy5jb21cIjtcbmNvbnN0IENEX0JBU0VfRElSID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgXCIuLlwiLCBcIi4uXCIsIFwiY2hyb21lZHJpdmVyXCIpO1xuY29uc3QgQ0RfUExBVFMgPSBbXCJsaW51eFwiLCBcIndpblwiLCBcIm1hY1wiXTtcbmNvbnN0IENEX0FSQ0hTID0gW1wiMzJcIiwgXCI2NFwiXTtcblxuY29uc3QgZ2V0Q3VyQXJjaCA9IFEuZGVub2RlaWZ5KHN5c3RlbS5hcmNoKTtcbmNvbnN0IHdyaXRlRmlsZSA9IFEuZGVub2RlaWZ5KGZzLndyaXRlRmlsZSk7XG5jb25zdCByZWFkRmlsZSA9IFEuZGVub2RlaWZ5KGZzLnJlYWRGaWxlKTtcbmNvbnN0IG1rZGlyID0gUS5kZW5vZGVpZnkoZnMubWtkaXIpO1xuY29uc3QgY2htb2QgPSBRLmRlbm9kZWlmeShmcy5jaG1vZCk7XG5jb25zdCBta2RpcnAgPSB1dGlsLm1rZGlycDtcblxuZnVuY3Rpb24gZ2V0Q3VyUGxhdGZvcm0gKCkge1xuICByZXR1cm4gc3lzdGVtLmlzV2luZG93cygpID8gXCJ3aW5cIiA6IChzeXN0ZW0uaXNNYWMoKSA/IFwibWFjXCIgOiBcImxpbnV4XCIpO1xufVxuXG5mdW5jdGlvbiBnZXRDaHJvbWVkcml2ZXJEaXIgKHBsYXRmb3JtID0gbnVsbCkge1xuICBpZiAoIXBsYXRmb3JtKSB7XG4gICAgcGxhdGZvcm0gPSBnZXRDdXJQbGF0Zm9ybSgpO1xuICB9XG4gIHJldHVybiBwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCAocGxhdGZvcm0gPSBudWxsLCBhcmNoID0gbnVsbCkge1xuICBpZiAoIXBsYXRmb3JtKSB7XG4gICAgcGxhdGZvcm0gPSBnZXRDdXJQbGF0Zm9ybSgpO1xuICB9XG4gIGNvbnN0IGJhc2VEaXIgPSBnZXRDaHJvbWVkcml2ZXJEaXIocGxhdGZvcm0pO1xuICBsZXQgZXh0ID0gXCJcIjtcbiAgaWYgKHBsYXRmb3JtID09PSBcIndpblwiKSB7XG4gICAgZXh0ID0gXCIuZXhlXCI7XG4gIH0gZWxzZSBpZiAocGxhdGZvcm0gPT09IFwibGludXhcIikge1xuICAgIGlmICghYXJjaCkge1xuICAgICAgYXJjaCA9IGF3YWl0IGdldEN1ckFyY2goKTtcbiAgICB9XG4gICAgZXh0ID0gXCJfXCIgKyBhcmNoO1xuICB9XG4gIHJldHVybiBwYXRoLnJlc29sdmUoYmFzZURpciwgYGNocm9tZWRyaXZlciR7ZXh0fWApO1xufVxuXG5mdW5jdGlvbiBnZXREb3dubG9hZFVybCAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgcmV0dXJuIGAke0NEX0NETn0vJHt2ZXJzaW9ufS9jaHJvbWVkcml2ZXJfJHtwbGF0Zm9ybX0ke2FyY2h9LnppcGA7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlUGxhdGZvcm0gKHBsYXRmb3JtLCBhcmNoKSB7XG4gIGlmICghXy5jb250YWlucyhDRF9QTEFUUywgcGxhdGZvcm0pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHBsYXRmb3JtOiAke3BsYXRmb3JtfWApO1xuICB9XG4gIGlmICghXy5jb250YWlucyhDRF9BUkNIUywgYXJjaCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgYXJjaDogJHthcmNofWApO1xuICB9XG4gIGlmIChhcmNoID09PSBcIjY0XCIgJiYgcGxhdGZvcm0gIT09IFwibGludXhcIikge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk9ubHkgbGludXggaGFzIGEgNjQtYml0IHZlcnNpb24gb2YgQ2hyb21lZHJpdmVyXCIpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxGb3JQbGF0Zm9ybSAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgdmFsaWRhdGVQbGF0Zm9ybShwbGF0Zm9ybSwgYXJjaCk7XG4gIGNvbnN0IHVybCA9IGdldERvd25sb2FkVXJsKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKTtcblxuICAvLyBzZXQgdXAgYSB0ZW1wIGZpbGUgdG8gZG93bmxvYWQgdGhlIGNocm9tZWRyaXZlciB6aXBmaWxlIHRvXG4gIGxldCBiaW5hcnlTcGVjID0gYGNocm9tZWRyaXZlcl8ke3BsYXRmb3JtfSR7YXJjaH1gO1xuICBsb2cuaW5mbyhgT3BlbmluZyB0ZW1wIGZpbGUgdG8gd3JpdGUgJHtiaW5hcnlTcGVjfSB0by4uLmApO1xuICBsZXQgdGVtcEZpbGUgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogYmluYXJ5U3BlYyxcbiAgICBzdWZmaXg6ICcuemlwJ1xuICB9KTtcblxuICAvLyBhY3R1YWxseSBkb3dubG9hZCB0aGUgemlwZmlsZSBhbmQgd3JpdGUgaXQgd2l0aCBhcHByb3ByaWF0ZSBwZXJtc1xuICBsb2cuaW5mbyhgRG93bmxvYWRpbmcgJHt1cmx9Li4uYCk7XG4gIGxldCBib2R5ID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybCwgZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIGJpbmFyeSBjb250ZW50IHRvICR7dGVtcEZpbGUucGF0aH0uLi5gKTtcbiAgYXdhaXQgd3JpdGVGaWxlKHRlbXBGaWxlLnBhdGgsIGJvZHksIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgYXdhaXQgY2htb2QodGVtcEZpbGUucGF0aCwgMG8wNjQ0KTtcblxuICAvLyBleHRyYWN0IGRvd25sb2FkZWQgemlwZmlsZSB0byB0ZW1wZGlyXG4gIGxldCB0ZW1wVW56aXBwZWQgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKHRlbXBGaWxlLnBhdGgpLCBiaW5hcnlTcGVjKTtcbiAgbG9nLmluZm8oYEV4dHJhY3RpbmcgJHt0ZW1wRmlsZS5wYXRofSB0byAke3RlbXBVbnppcHBlZH1gKTtcbiAgYXdhaXQgbWtkaXIodGVtcFVuemlwcGVkKTtcbiAgbGV0IHppcCA9IG5ldyBBZG1aaXAodGVtcEZpbGUucGF0aCk7XG4gIHppcC5leHRyYWN0QWxsVG8odGVtcFVuemlwcGVkLCB0cnVlKTtcbiAgbGV0IGV4dHJhY3RlZEJpbiA9IHBhdGgucmVzb2x2ZSh0ZW1wVW56aXBwZWQsIFwiY2hyb21lZHJpdmVyXCIpO1xuICBpZiAocGxhdGZvcm0gPT09IFwid2luXCIpIHtcbiAgICBleHRyYWN0ZWRCaW4gKz0gXCIuZXhlXCI7XG4gIH1cblxuICAvLyBtYWtlIGJ1aWxkIGRpcnMgdGhhdCB3aWxsIGhvbGQgdGhlIGNocm9tZWRyaXZlciBiaW5hcnlcbiAgbG9nLmluZm8oYENyZWF0aW5nICR7cGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSl9Li4uYCk7XG4gIGF3YWl0IG1rZGlycChDRF9CQVNFX0RJUik7XG4gIGF3YWl0IG1rZGlycChwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKSk7XG5cbiAgLy8gY29weSB0aGUgZXh0cmFjdGVkIGJpbmFyeSB0byB0aGUgY29ycmVjdCBidWlsZCBkaXJcbiAgbGV0IG5ld0JpbiA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBsb2cuaW5mbyhgQ29weWluZyB1bnppcHBlZCBiaW5hcnksIHJlYWRpbmcgZnJvbSAke2V4dHJhY3RlZEJpbn0uLi5gKTtcbiAgbGV0IGJpbkNvbnRlbnRzID0gYXdhaXQgcmVhZEZpbGUoZXh0cmFjdGVkQmluLCB7ZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZy5pbmZvKGBXcml0aW5nIHRvICR7bmV3QmlufS4uLmApO1xuICBhd2FpdCB3cml0ZUZpbGUobmV3QmluLCBiaW5Db250ZW50cywge2VuY29kaW5nOiAnYmluYXJ5JywgbW9kZTogMG83NTV9KTtcbiAgbG9nLmluZm8oYCR7bmV3QmlufSBzdWNjZXNzZnVsbHkgcHV0IGluIHBsYWNlYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGwgKCkge1xuICBsZXQgYXJjaCA9IGF3YWl0IGdldEN1ckFyY2goKSwgcGxhdGZvcm0gPSBnZXRDdXJQbGF0Zm9ybSgpO1xuICBpZiAocGxhdGZvcm0gIT09IFwibGludXhcIiAmJiBhcmNoID09PSBcIjY0XCIpIHtcbiAgICBhcmNoID0gXCIzMlwiO1xuICB9XG4gIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY29uZGl0aW9uYWxJbnN0YWxsICgpIHtcbiAgbGV0IGFyY2ggPSBhd2FpdCBnZXRDdXJBcmNoKCksIHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgaWYgKHBsYXRmb3JtICE9PSBcImxpbnV4XCIgJiYgYXJjaCA9PT0gXCI2NFwiKSB7XG4gICAgYXJjaCA9IFwiMzJcIjtcbiAgfVxuICBsZXQgYmluUGF0aCA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBpZiAoIShhd2FpdCBleGlzdHMoYmluUGF0aCkpKSB7XG4gICAgYXdhaXQgaW5zdGFsbEZvclBsYXRmb3JtKENEX1ZFUiwgcGxhdGZvcm0sIGFyY2gpO1xuICB9IGVsc2Uge1xuICAgIGxvZy5pbmZvKGBObyBuZWVkIHRvIGluc3RhbGwgY2hyb21lZHJpdmVyLCAke2JpblBhdGh9IGV4aXN0c2ApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxBbGwgKCkge1xuICBjb25zdCBwbGF0cyA9IFtcbiAgICBbJ2xpbnV4JywgJzMyJ10sXG4gICAgWydsaW51eCcsICc2NCddLFxuICAgIFsnd2luJywgJzMyJ10sXG4gICAgWydtYWMnLCAnMzInXVxuICBdO1xuICBsZXQgZG93bmxvYWRzID0gW107XG4gIGZvciAobGV0IFtwbGF0Zm9ybSwgYXJjaF0gb2YgcGxhdHMpIHtcbiAgICBkb3dubG9hZHMucHVzaChpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCkpO1xuICB9XG4gIGF3YWl0IGxsKGRvd25sb2Fkcyk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGRvSW5zdGFsbCAoKSB7XG4gIGlmIChfLmNvbnRhaW5zKHByb2Nlc3MuYXJndiwgJy0tYWxsJykpIHtcbiAgICBhd2FpdCBpbnN0YWxsQWxsKCk7XG4gIH0gZWxzZSBpZiAoXy5jb250YWlucyhwcm9jZXNzLmFyZ3YsICctLWNvbmRpdGlvbmFsJykpIHtcbiAgICBhd2FpdCBjb25kaXRpb25hbEluc3RhbGwoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBpbnN0YWxsKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aCwgaW5zdGFsbCwgaW5zdGFsbEFsbCwgQ0RfQkFTRV9ESVIsXG4gICAgICAgICBnZXRDdXJQbGF0Zm9ybSwgY29uZGl0aW9uYWxJbnN0YWxsLCBkb0luc3RhbGx9O1xuIl19