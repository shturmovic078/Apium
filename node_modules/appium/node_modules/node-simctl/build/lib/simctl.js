'use strict';

var _Object$defineProperty = require('babel-runtime/core-js/object/define-property')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

_Object$defineProperty(exports, '__esModule', {
  value: true
});

var _q = require('q');

var _q2 = _interopRequireDefault(_q);

var _child_process = require('child_process');

var _child_process2 = _interopRequireDefault(_child_process);

var _asyncbox = require('asyncbox');

var _npmlog = require('npmlog');

var _npmlog2 = _interopRequireDefault(_npmlog);

var _es6Mapify = require('es6-mapify');

var log = global._global_npmlog || _npmlog2['default'];

function simExec(cmd, timeout) {
  var args = arguments[2] === undefined ? [] : arguments[2];

  args = args.map(function (arg) {
    if (arg.indexOf(' ') !== -1) {
      return '"' + arg + '"';
    }
    return arg;
  });
  cmd = 'xcrun simctl ' + cmd + ' ' + args.join(' ');
  log.info('Executing: ' + cmd + ' with timeout ' + timeout);
  return _q2['default'].nfcall(_child_process2['default'].exec, cmd, { timeout: timeout });
}

function installApp(udid, appPath) {
  return _regeneratorRuntime.async(function installApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('install', 0, [udid, appPath]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function removeApp(udid, bundleId) {
  return _regeneratorRuntime.async(function removeApp$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('uninstall', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function launch(udid, bundleId) {
  return _regeneratorRuntime.async(function launch$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('launch', 0, [udid, bundleId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function createDevice(name, deviceTypeId, runtimeId) {
  return _regeneratorRuntime.async(function createDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('create', 0, [name, deviceTypeId, runtimeId]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function deleteDevice(udid) {
  return _regeneratorRuntime.async(function deleteDevice$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('delete', 0, [udid]));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function eraseDevice(udid) {
  var cmdTimeout, cmdRetry, loopFn;
  return _regeneratorRuntime.async(function eraseDevice$(context$1$0) {
    var _this = this;

    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        cmdTimeout = 2000, cmdRetry = 5;

        loopFn = function loopFn() {
          var ms;
          return _regeneratorRuntime.async(function loopFn$(context$2$0) {
            while (1) switch (context$2$0.prev = context$2$0.next) {
              case 0:
                ms = Date.now();
                context$2$0.prev = 1;
                context$2$0.next = 4;
                return _regeneratorRuntime.awrap(simExec('erase', cmdTimeout, [udid]));

              case 4:
                context$2$0.next = 11;
                break;

              case 6:
                context$2$0.prev = 6;
                context$2$0.t0 = context$2$0['catch'](1);
                context$2$0.next = 10;
                return _regeneratorRuntime.awrap((0, _asyncbox.sleep)(Math.max(cmdTimeout - (Date.now() - ms), 1)));

              case 10:
                throw context$2$0.t0;

              case 11:
              case 'end':
                return context$2$0.stop();
            }
          }, null, _this, [[1, 6]]);
        };

        context$1$0.next = 4;
        return _regeneratorRuntime.awrap((0, _asyncbox.retry)(cmdRetry, loopFn));

      case 4:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
}

function getDevices() {
  var forSdk = arguments[0] === undefined ? null : arguments[0];

  var res, stdout, deviceSecRe, matches, devices, match, _iteratorNormalCompletion, _didIteratorError, _iteratorError, _iterator, _step, sdk, _iteratorNormalCompletion2, _didIteratorError2, _iteratorError2, _iterator2, _step2, line, lineRe, lineMatch, device;

  return _regeneratorRuntime.async(function getDevices$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(simExec('list', 0, ['devices']));

      case 2:
        res = context$1$0.sent;
        stdout = res[0];
        deviceSecRe = /-- iOS (.+) --(\n    .+)*/mg;
        matches = [];
        devices = {};
        match = deviceSecRe.exec(stdout);

        while (match !== null) {
          matches.push(match);
          match = deviceSecRe.exec(stdout);
        }

        if (!(matches.length < 1)) {
          context$1$0.next = 11;
          break;
        }

        throw new Error('Could not find device section');

      case 11:
        _iteratorNormalCompletion = true;
        _didIteratorError = false;
        _iteratorError = undefined;
        context$1$0.prev = 14;
        _iterator = _getIterator(matches);

      case 16:
        if (_iteratorNormalCompletion = (_step = _iterator.next()).done) {
          context$1$0.next = 56;
          break;
        }

        match = _step.value;
        sdk = match[1];

        devices[sdk] = [];
        _iteratorNormalCompletion2 = true;
        _didIteratorError2 = false;
        _iteratorError2 = undefined;
        context$1$0.prev = 23;
        _iterator2 = _getIterator(match[0].split('\n').slice(1));

      case 25:
        if (_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done) {
          context$1$0.next = 39;
          break;
        }

        line = _step2.value;
        lineRe = /^    ([^\(]+) \(([^\)]+)\) \(([^\)]+)\)/;
        lineMatch = lineRe.exec(line);

        if (!(lineMatch === null)) {
          context$1$0.next = 31;
          break;
        }

        throw new Error('Couldn\'t match line');

      case 31:
        device = {};

        device.name = lineMatch[1];
        device.udid = lineMatch[2];
        device.state = lineMatch[3];
        devices[sdk].push(device);

      case 36:
        _iteratorNormalCompletion2 = true;
        context$1$0.next = 25;
        break;

      case 39:
        context$1$0.next = 45;
        break;

      case 41:
        context$1$0.prev = 41;
        context$1$0.t0 = context$1$0['catch'](23);
        _didIteratorError2 = true;
        _iteratorError2 = context$1$0.t0;

      case 45:
        context$1$0.prev = 45;
        context$1$0.prev = 46;

        if (!_iteratorNormalCompletion2 && _iterator2['return']) {
          _iterator2['return']();
        }

      case 48:
        context$1$0.prev = 48;

        if (!_didIteratorError2) {
          context$1$0.next = 51;
          break;
        }

        throw _iteratorError2;

      case 51:
        return context$1$0.finish(48);

      case 52:
        return context$1$0.finish(45);

      case 53:
        _iteratorNormalCompletion = true;
        context$1$0.next = 16;
        break;

      case 56:
        context$1$0.next = 62;
        break;

      case 58:
        context$1$0.prev = 58;
        context$1$0.t1 = context$1$0['catch'](14);
        _didIteratorError = true;
        _iteratorError = context$1$0.t1;

      case 62:
        context$1$0.prev = 62;
        context$1$0.prev = 63;

        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }

      case 65:
        context$1$0.prev = 65;

        if (!_didIteratorError) {
          context$1$0.next = 68;
          break;
        }

        throw _iteratorError;

      case 68:
        return context$1$0.finish(65);

      case 69:
        return context$1$0.finish(62);

      case 70:
        if (!forSdk) {
          context$1$0.next = 74;
          break;
        }

        if (devices[forSdk]) {
          context$1$0.next = 73;
          break;
        }

        throw new Error('Sdk ' + forSdk + ' was not in list of simctl sdks');

      case 73:
        return context$1$0.abrupt('return', devices[forSdk]);

      case 74:
        return context$1$0.abrupt('return', devices);

      case 75:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[14, 58, 62, 70], [23, 41, 45, 53], [46,, 48, 52], [63,, 65, 69]]);
}

exports.installApp = installApp;
exports.removeApp = removeApp;
exports.launch = launch;
exports.createDevice = createDevice;
exports.deleteDevice = deleteDevice;
exports.eraseDevice = eraseDevice;
exports.getDevices = getDevices;

// retry erase with a sleep in between because it's flakey
//# sourceMappingURL=data:application/json;base64,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LEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLGNBQU0sQ0FBQyxJQUFJLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNCLGNBQU0sQ0FBQyxLQUFLLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzVCLGVBQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OzthQUcxQixNQUFNOzs7OztZQUNILE9BQU8sQ0FBQyxNQUFNLENBQUM7Ozs7O2NBQ1osSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLE1BQU0sR0FBRyxpQ0FBaUMsQ0FBQzs7OzRDQUUvRCxPQUFPLENBQUMsTUFBTSxDQUFDOzs7NENBRWpCLE9BQU87Ozs7Ozs7Q0FDZjs7UUFFUSxVQUFVLEdBQVYsVUFBVTtRQUFFLFNBQVMsR0FBVCxTQUFTO1FBQUUsTUFBTSxHQUFOLE1BQU07UUFBRSxZQUFZLEdBQVosWUFBWTtRQUFFLFlBQVksR0FBWixZQUFZO1FBQUUsV0FBVyxHQUFYLFdBQVc7UUFBRSxVQUFVLEdBQVYsVUFBVSIsImZpbGUiOiJsaWIvc2ltY3RsLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFEgZnJvbSAncSc7XG5pbXBvcnQgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgeyBzbGVlcCwgcmV0cnksIG5vZGVpZnlBbGwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbnBtbG9nIGZyb20gJ25wbWxvZyc7XG5pbXBvcnQgeyBtYXBpZnkgfSBmcm9tICdlczYtbWFwaWZ5JztcblxubGV0IGxvZyA9IGdsb2JhbC5fZ2xvYmFsX25wbWxvZyB8fCBucG1sb2c7XG5cbmZ1bmN0aW9uIHNpbUV4ZWMgKGNtZDpzdHJpbmcsIHRpbWVvdXQ6bnVtYmVyLCBhcmdzOkFycmF5ID0gW10pIHtcbiAgYXJncyA9IGFyZ3MubWFwKChhcmcpID0+IHtcbiAgICBpZiAoYXJnLmluZGV4T2YoXCIgXCIpICE9PSAtMSkge1xuICAgICAgcmV0dXJuICdcIicgKyBhcmcgKyAnXCInO1xuICAgIH1cbiAgICByZXR1cm4gYXJnO1xuICB9KTtcbiAgY21kID0gXCJ4Y3J1biBzaW1jdGwgXCIgKyBjbWQgKyBcIiBcIiArIGFyZ3Muam9pbignICcpO1xuICBsb2cuaW5mbyhcIkV4ZWN1dGluZzogXCIgKyBjbWQgKyBcIiB3aXRoIHRpbWVvdXQgXCIgKyB0aW1lb3V0KTtcbiAgcmV0dXJuIFEubmZjYWxsKGNwLmV4ZWMsIGNtZCwge3RpbWVvdXR9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFwcCAodWRpZDpzdHJpbmcsIGFwcFBhdGg6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYyhcImluc3RhbGxcIiwgMCwgW3VkaWQsIGFwcFBhdGhdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVtb3ZlQXBwICh1ZGlkOnN0cmluZywgYnVuZGxlSWQ6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYyhcInVuaW5zdGFsbFwiLCAwLCBbdWRpZCwgYnVuZGxlSWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gbGF1bmNoICh1ZGlkOnN0cmluZywgYnVuZGxlSWQ6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYyhcImxhdW5jaFwiLCAwLCBbdWRpZCwgYnVuZGxlSWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlRGV2aWNlIChuYW1lOnN0cmluZywgZGV2aWNlVHlwZUlkOnN0cmluZyxcbiAgICBydW50aW1lSWQ6c3RyaW5nKTp2b2lkIHtcbiAgYXdhaXQgc2ltRXhlYyhcImNyZWF0ZVwiLCAwLCBbbmFtZSwgZGV2aWNlVHlwZUlkLCBydW50aW1lSWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZGVsZXRlRGV2aWNlICh1ZGlkOnN0cmluZyk6dm9pZCB7XG4gIGF3YWl0IHNpbUV4ZWMoXCJkZWxldGVcIiwgMCwgW3VkaWRdKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZXJhc2VEZXZpY2UgKHVkaWQ6c3RyaW5nKTp2b2lkIHtcbiAgbGV0IGNtZFRpbWVvdXQ6bnVtYmVyID0gMjAwMCwgY21kUmV0cnk6bnVtYmVyID0gNTtcbiAgbGV0IGxvb3BGbjpGdW5jdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICBsZXQgbXMgPSBEYXRlLm5vdygpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBzaW1FeGVjKFwiZXJhc2VcIiwgY21kVGltZW91dCwgW3VkaWRdKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBhd2FpdCBzbGVlcChNYXRoLm1heChjbWRUaW1lb3V0IC0gKERhdGUubm93KCkgLSBtcyksIDEpKTtcbiAgICAgIHRocm93IGU7XG4gICAgfVxuICB9O1xuICAvLyByZXRyeSBlcmFzZSB3aXRoIGEgc2xlZXAgaW4gYmV0d2VlbiBiZWNhdXNlIGl0J3MgZmxha2V5XG4gIGF3YWl0IHJldHJ5KGNtZFJldHJ5LCBsb29wRm4pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXREZXZpY2VzIChmb3JTZGs6c3RyaW5nID0gbnVsbCk6T2JqZWN0IHtcbiAgbGV0IHJlczpBcnJheSA9IGF3YWl0IHNpbUV4ZWMoXCJsaXN0XCIsIDAsIFtcImRldmljZXNcIl0pO1xuICBsZXQgc3Rkb3V0OnN0cmluZyA9IHJlc1swXTtcbiAgbGV0IGRldmljZVNlY1JlOlJlZ0V4cCA9IC8tLSBpT1MgKC4rKSAtLShcXG4gICAgLispKi9tZztcbiAgbGV0IG1hdGNoZXM6QXJyYXkgPSBbXTtcbiAgbGV0IGRldmljZXM6T2JqZWN0ID0ge307XG4gIGxldCBtYXRjaDpPYmplY3QgPSBkZXZpY2VTZWNSZS5leGVjKHN0ZG91dCk7XG4gIHdoaWxlIChtYXRjaCAhPT0gbnVsbCkge1xuICAgIG1hdGNoZXMucHVzaChtYXRjaCk7XG4gICAgbWF0Y2ggPSBkZXZpY2VTZWNSZS5leGVjKHN0ZG91dCk7XG4gIH1cbiAgaWYgKG1hdGNoZXMubGVuZ3RoIDwgMSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkNvdWxkIG5vdCBmaW5kIGRldmljZSBzZWN0aW9uXCIpO1xuICB9XG4gIGZvciAobWF0Y2ggb2YgbWF0Y2hlcykge1xuICAgIGxldCBzZGs6c3RyaW5nID0gbWF0Y2hbMV07XG4gICAgZGV2aWNlc1tzZGtdID0gW107XG4gICAgZm9yIChsZXQgbGluZTpzdHJpbmcgb2YgbWF0Y2hbMF0uc3BsaXQoXCJcXG5cIikuc2xpY2UoMSkpIHtcbiAgICAgIGxldCBsaW5lUmU6UmVnRXhwID0gL14gICAgKFteXFwoXSspIFxcKChbXlxcKV0rKVxcKSBcXCgoW15cXCldKylcXCkvO1xuICAgICAgbGV0IGxpbmVNYXRjaDpPYmplY3QgPSBsaW5lUmUuZXhlYyhsaW5lKTtcbiAgICAgIGlmIChsaW5lTWF0Y2ggPT09IG51bGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ291bGRuJ3QgbWF0Y2ggbGluZVwiKTtcbiAgICAgIH1cbiAgICAgIGxldCBkZXZpY2U6T2JqZWN0ID0ge307XG4gICAgICBkZXZpY2UubmFtZSA9IGxpbmVNYXRjaFsxXTtcbiAgICAgIGRldmljZS51ZGlkID0gbGluZU1hdGNoWzJdO1xuICAgICAgZGV2aWNlLnN0YXRlID0gbGluZU1hdGNoWzNdO1xuICAgICAgZGV2aWNlc1tzZGtdLnB1c2goZGV2aWNlKTtcbiAgICB9XG4gIH1cbiAgaWYgKGZvclNkaykge1xuICAgIGlmICghZGV2aWNlc1tmb3JTZGtdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJTZGsgXCIgKyBmb3JTZGsgKyBcIiB3YXMgbm90IGluIGxpc3Qgb2Ygc2ltY3RsIHNka3NcIik7XG4gICAgfVxuICAgIHJldHVybiBkZXZpY2VzW2ZvclNka107XG4gIH1cbiAgcmV0dXJuIGRldmljZXM7XG59XG5cbmV4cG9ydCB7IGluc3RhbGxBcHAsIHJlbW92ZUFwcCwgbGF1bmNoLCBjcmVhdGVEZXZpY2UsIGRlbGV0ZURldmljZSwgZXJhc2VEZXZpY2UsIGdldERldmljZXMgfTtcbiJdfQ==